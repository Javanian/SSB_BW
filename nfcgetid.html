<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Scan NFC - UserNFC</title>
</head>
<body>
  <h1>Scan NFC 3</h1>

  <button id="btnScan">Mulai Scan NFC 3</button>
  <button id="btnStop" disabled>Stop Scan</button>

  <div>
    <label for="infoBox">Info:</label>
    <input id="infoBox" type="text" readonly style="width: 100%;"/>
  </div>

  <div>
    <p id="status">Status: Idle</p>
    <p>ID NFC terbaca: <span id="nfcIdDisplay">-</span></p>
  </div>

  <h3>Data Karyawan</h3>
  <pre id="resultView">-</pre>

  <script>
    // ===================== KONFIGURASI =====================
// ===================== KONFIG =====================
const API_BASE_URL = "https://playback-pubmed-chosen-additionally.trycloudflare.com";
// Route server: router.get("/nfcid/:nfcid", controller.getdatausernfc);

// ===================== ELEMENT UI =================
const btnScan = document.getElementById("btnScan");
const btnStop = document.getElementById("btnStop");
const statusEl = document.getElementById("status");
const infoBox = document.getElementById("infoBox");
const nfcIdDisplay = document.getElementById("nfcIdDisplay");
const resultView = document.getElementById("resultView");

// ===================== STATE ======================
let reader = null;
let scanning = false;
let clearInfoTimer = null;

// ===================== UTIL =======================
function setStatus(text) {
  statusEl.textContent = "Status: " + text;
}
function showInfo(text, autoClearMs = 2000) {
  infoBox.value = text || "";
  if (clearInfoTimer) clearTimeout(clearInfoTimer);
  if (text && autoClearMs) {
    clearInfoTimer = setTimeout(() => (infoBox.value = ""), autoClearMs);
  }
}
function showResult(obj) {
  resultView.textContent = obj ? JSON.stringify(obj, null, 2) : "-";
}

// Buat URL TANPA encodeURIComponent, dengan nfcid ber-kutip
function buildUserUrl(nfcidRaw) {
  const asString = String(nfcidRaw);     // pastikan string
  const quoted   = `"${asString}"`;      // tambahkan tanda kutip
  // langsung tempel ke path
  return `${API_BASE_URL}/usernfc/nfcid/${quoted}`;
}

// Decode TextRecord jika serialNumber kosong
function decodeTextRecord(record) {
  try {
    const textDecoder = new TextDecoder(record.encoding || "utf-8");
    return textDecoder.decode(record.data);
  } catch {
    return "";
  }
}

// Ambil ID NFC: prefer serialNumber, fallback ke TextRecord
function extractNfcIdFromReading(event) {
  if (event.serialNumber && event.serialNumber.trim() !== "") {
    return event.serialNumber.trim();
  }
  const records = event.message?.records || [];
  for (const rec of records) {
    if (rec.recordType === "text") {
      const val = decodeTextRecord(rec).trim();
      if (val) return val;
    }
  }
  return "";
}

// Panggil API (server balikin rows[0] atau null)
async function fetchUserByNfcId(nfcidRaw) {
  const url = buildUserUrl(nfcidRaw);
  console.log("Fetch URL:", url); // debug
  const res = await fetch(url, { method: "GET" });
  if (!res.ok) {
    // kalau error HTTP, lempar supaya ketangkep di catch
    const text = await res.text().catch(() => "");
    throw new Error(`HTTP ${res.status}: ${text}`);
  }
  const data = await res.json().catch(() => null);
  const found = !!(data && Object.keys(data).length > 0);
  return { found, data: found ? data : null };
}

// ===================== NFC LOGIC ==================
async function startScan() {
  if (!("NDEFReader" in window)) {
    setStatus("Browser tidak mendukung Web NFC.");
    showInfo("Web NFC hanya di Chrome Android & HTTPS/localhost");
    return;
  }
  try {
    reader = new NDEFReader();
    await reader.scan(); // minta izin & mulai listening
    scanning = true;
    btnScan.disabled = true;
    btnStop.disabled = false;
    setStatus("Scanning... tempelkan tag NFC");

    reader.onreadingerror = () => {
      setStatus("Gagal membaca NFC, coba lagi.");
    };

    reader.onreading = async (event) => {
      setStatus("Tag terbaca! memproses...");
      showInfo("");
      showResult(null);

      // 1) Ambil NFC ID sebagai string
      const rawNfcId = extractNfcIdFromReading(event);
      const asString = String(rawNfcId);

      // tampilkan di UI dalam bentuk ber-kutip biar sama dengan yang dikirim
      nfcIdDisplay.textContent = `"${asString}"`;

      if (!asString) {
        setStatus("ID NFC kosong, coba tag lain.");
        sessionStorage.removeItem("datakaryawan");
        return;
      }

      try {
        // 2) Call API dgn nfcid ber-kutip & tanpa encode
        const { found, data } = await fetchUserByNfcId(asString);

        if (found) {
          setStatus("Data karyawan ditemukan.");
          showResult(data);
          // 3) Simpan ke sessionStorage untuk dipakai di halaman lain
          sessionStorage.setItem("datakaryawan", JSON.stringify(data));
        } else {
          setStatus("Karyawan tidak ditemukan.");
          showResult(null);
          showInfo("karyawan tidak ditemukan", 2000);
          sessionStorage.removeItem("datakaryawan");
        }
      } catch (err) {
        setStatus("Error saat ambil data.");
        showInfo("Gagal memanggil API: " + err.message, 2000);
        sessionStorage.removeItem("datakaryawan");
      } finally {
        setStatus("Scanning... tempelkan tag NFC berikutnya");
      }
    };
  } catch (err) {
    setStatus("Tidak bisa mulai scan: " + err.message);
  }
}

function stopScan() {
  if (reader) {
    reader.onreading = null;
    reader.onreadingerror = null;
  }
  scanning = false;
  btnScan.disabled = false;
  btnStop.disabled = true;
  setStatus("Scan dihentikan.");
}

// ===================== EVENT UI ==================
btnScan.addEventListener("click", () => {
  if (!scanning) startScan();
});
btnStop.addEventListener("click", () => {
  if (scanning) stopScan();
});





  </script>
</body>
</html>



