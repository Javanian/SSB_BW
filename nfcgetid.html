<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Scan NFC - UserNFC</title>
</head>
<body>
  <h1>Scan NFC 2</h1>

  <button id="btnScan">Mulai Scan NFC 2</button>
  <button id="btnStop" disabled>Stop Scan</button>

  <div>
    <label for="infoBox">Info:</label>
    <input id="infoBox" type="text" readonly style="width: 100%;"/>
  </div>

  <div>
    <p id="status">Status: Idle</p>
    <p>ID NFC terbaca: <span id="nfcIdDisplay">-</span></p>
  </div>

  <h3>Data Karyawan</h3>
  <pre id="resultView">-</pre>

  <script>
    // ===================== KONFIGURASI =====================
const API_BASE_URL = "https://playback-pubmed-chosen-additionally.trycloudflare.com";
// Endpoint akhir yang dipanggil akan menjadi:
// https://playback-pubmed-chosen-additionally.trycloudflare.com/usernfc/nfcid/"42:b7:db:69"
// (di jaringan, browser akan mengirim versi ter-encode: %22 = " dan %3A = :)

// ===================== ELEMENT UI ======================
const btnScan = document.getElementById("btnScan");
const btnStop = document.getElementById("btnStop");
const statusEl = document.getElementById("status");
const infoBox = document.getElementById("infoBox");
const nfcIdDisplay = document.getElementById("nfcIdDisplay");
const resultView = document.getElementById("resultView");

// ===================== STATE ===========================
let reader = null;
let scanning = false;
let clearInfoTimer = null;

// ===================== UTIL/UI =========================
function setStatus(text) {
  statusEl.textContent = "Status: " + text;
}

function showInfo(text, autoClearMs = 2000) {
  infoBox.value = text || "";
  if (clearInfoTimer) clearTimeout(clearInfoTimer);
  if (text && autoClearMs) {
    clearInfoTimer = setTimeout(() => (infoBox.value = ""), autoClearMs);
  }
}

function showResult(obj) {
  resultView.textContent = obj ? JSON.stringify(obj, null, 2) : "-";
}

// Bangun URL sesuai route: /usernfc/nfcid/:nfcid
// PERMINTAAN: nilai :nfcid DIKIRIM DENGAN TANDA KUTIP, mis. "42:b7:db:69"
function buildUserUrl(nfcidRaw) {
  // pastikan string
  const asString = String(nfcidRaw);
  // bungkus dengan tanda kutip
  const quoted = `"${asString}"`;
  // encode untuk aman di path param
  const encoded = encodeURIComponent(quoted);
  return `${API_BASE_URL}/usernfc/nfcid/${encoded}`;
}

// Decode TextRecord jika serialNumber kosong
function decodeTextRecord(record) {
  try {
    const textDecoder = new TextDecoder(record.encoding || "utf-8");
    return textDecoder.decode(record.data);
  } catch {
    return "";
  }
}

// Ambil ID NFC dari event: prefer serialNumber, fallback ke TextRecord
function extractNfcIdFromReading(event) {
  if (event.serialNumber && event.serialNumber.trim() !== "") {
    return event.serialNumber.trim(); // biasanya format "xx:xx:xx:xx"
  }
  const records = event.message?.records || [];
  for (const rec of records) {
    if (rec.recordType === "text") {
      const val = decodeTextRecord(rec).trim();
      if (val) return val;
    }
  }
  return "";
}

// ===================== API CALL ========================
async function fetchUserByNfcId(nfcidRaw) {
  const url = buildUserUrl(nfcidRaw);
  const res = await fetch(url, { method: "GET" });

  // Controller kamu: res.json(result.rows[0]);
  // Jadi "tidak ditemukan" = data null/undefined (bukan 404).
  if (!res.ok) {
    const text = await res.text().catch(() => "");
    throw new Error(`HTTP ${res.status}: ${text}`);
  }

  const data = await res.json().catch(() => null);
  const found = !!(data && Object.keys(data).length > 0);
  return { found, data: found ? data : null, urlUsed: url };
}

// ===================== NFC LOGIC =======================
async function startScan() {
  if (!("NDEFReader" in window)) {
    setStatus("Browser tidak mendukung Web NFC.");
    showInfo("Web NFC hanya di Chrome Android & HTTPS/localhost");
    return;
  }
  try {
    reader = new NDEFReader();
    await reader.scan(); // minta izin & mulai listening
    scanning = true;
    btnScan.disabled = true;
    btnStop.disabled = false;
    setStatus("Scanning... tempelkan tag NFC");

    reader.onreadingerror = () => {
      setStatus("Gagal membaca NFC, coba lagi.");
    };

    reader.onreading = async (event) => {
      setStatus("Tag terbaca! memproses...");
      showInfo("");
      showResult(null);

      // 1) Ambil NFC ID lalu pastikan string
      const rawNfcId = extractNfcIdFromReading(event);
      const asString = String(rawNfcId); // *pastikan string*
      nfcIdDisplay.textContent = `"${asString}"`; // tampilkan versi ber-kutip biar match API

      if (!asString) {
        setStatus("ID NFC kosong, coba tag lain.");
        sessionStorage.removeItem("datakaryawan");
        return;
      }

      try {
        // 2) Panggil API dengan nfcid yang akan DIKIRIM BER-KUTIP
        const { found, data /*, urlUsed*/ } = await fetchUserByNfcId(asString);

        if (found) {
          setStatus("Data karyawan ditemukan.");
          showResult(data);

          // 3) SIMPAN KE SESSIONSTORAGE AGAR BISA DIPAKAI DI PAGE LAIN
          sessionStorage.setItem("datakaryawan", JSON.stringify(data));
        } else {
          setStatus("Karyawan tidak ditemukan.");
          showResult(null);
          showInfo("karyawan tidak ditemukan", 2000);
          sessionStorage.removeItem("datakaryawan");
        }
      } catch (err) {
        setStatus("Error saat ambil data.");
        showInfo("Gagal memanggil API: " + err.message, 2000);
        sessionStorage.removeItem("datakaryawan");
      } finally {
        // 4) Biarkan tetap listen untuk scan berikutnya
        setStatus("Scanning... tempelkan tag NFC berikutnya");
      }
    };
  } catch (err) {
    setStatus("Tidak bisa mulai scan: " + err.message);
  }
}

function stopScan() {
  if (reader) {
    reader.onreading = null;
    reader.onreadingerror = null;
  }
  scanning = false;
  btnScan.disabled = false;
  btnStop.disabled = true;
  setStatus("Scan dihentikan.");
}

// ===================== EVENT UI =======================
btnScan.addEventListener("click", () => {
  if (!scanning) startScan();
});
btnStop.addEventListener("click", () => {
  if (scanning) stopScan();
});




  </script>
</body>
</html>


